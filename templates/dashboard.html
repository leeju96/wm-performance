<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WMÏÑ±Í≥º</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/static/service-worker.js");
      }
    </script>
    <meta name="theme-color" content="#000000">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">

<!-- üî• Î©îÎâ¥Î∞î -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">WM ÏÑ±Í≥º</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <li class="nav-item">
          <a class="nav-link" href="/notice">Í≥µÏßÄÏÇ¨Ìï≠</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/tip">Tip</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="/">Ìôà</a>
        </li>

      </ul>

      <!-- Ïò§Î•∏Ï™Ω Î°úÍ∑∏ÏïÑÏõÉ -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-danger" href="/logout">Î°úÍ∑∏ÏïÑÏõÉ</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


<!-- üî• Ïª®ÌÖêÏ∏† ÏãúÏûë -->
<div class="container py-4">

    <h1 class="mb-1">WMÏÑ±Í≥º</h1>
    <p class="text-muted mb-4">Ïò§Îäò ÎÇ†Ïßú: {{ today.strftime('%Y-%m-%d') }}</p>

    <!-- ÌåÄÏõê Î™©Î°ù -->
    <div class="card mb-4">
        <div class="card-header">ÌåÄÏõê Î™©Î°ù</div>
        <div class="card-body">
            {% if members %}
                <ul class="mb-0">
                    {% for m in members %}
                    <li>
                        <a href="/member/{{ m.id }}">{{ m.name }}</a>
                        {% if m.role %} 
                            <span class="text-muted">({{ m.role }})</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted mb-0">Îì±Î°ùÎêú ÌåÄÏõêÏù¥ ÏóÜÏäµÎãàÎã§.</p>
            {% endif %}
        </div>
    </div>


    <!-- Ï°∞Ìöå Ïõî + ÎÇ†Ïßú Í∏∞Í∞Ñ Í≤ÄÏÉâ -->
    <form method="get" class="mb-4">

        <div class="row g-2 align-items-center mb-2">
            <div class="col-auto"><label class="col-form-label">Ï°∞Ìöå Ïõî</label></div>
            <div class="col-auto">
                <input type="month" name="month" class="form-control" value="{{ current_month }}">
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-primary">Ïõî Ï†ÅÏö©</button>
            </div>
        </div>

        <div class="row g-2 align-items-center">
            <div class="col-auto"><label class="col-form-label">Í∏∞Í∞Ñ Í≤ÄÏÉâ</label></div>
            <div class="col-auto"><input type="date" name="start_date" class="form-control" value="{{ start_date_value }}"></div>
            <div class="col-auto"><span class="col-form-label">~</span></div>
            <div class="col-auto"><input type="date" name="end_date" class="form-control" value="{{ end_date_value }}"></div>
            <div class="col-auto"><button class="btn btn-outline-success">Í∏∞Í∞Ñ Ï†ÅÏö©</button></div>
            <div class="col-auto">
                <button class="btn btn-outline-secondary" 
                        onclick="this.form.start_date.value=''; this.form.end_date.value='';">
                    Ï¥àÍ∏∞Ìôî
                </button>
            </div>
        </div>

    </form>


    <!-- ÌåÄÏõê Ï∂îÍ∞Ä & ÏÑ±Í≥º Í∏∞Î°ù ÏûÖÎ†• -->
    <div class="row mb-4">

        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">ÌåÄÏõê Ï∂îÍ∞Ä</div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('add_member') }}">
                        <div class="mb-2">
                            <label class="form-label">Ïù¥Î¶Ñ</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">ÏßÅÏ±Ö</label>
                            <input type="text" name="role" class="form-control">
                        </div>

                        <button class="btn btn-primary w-100">Ï∂îÍ∞Ä</button>
                    </form>
                </div>
            </div>
        </div>


        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header">ÏÑ±Í≥º Í∏∞Î°ù ÏûÖÎ†•</div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('add_log') }}">

                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">ÎÇ†Ïßú</label>
                                <input type="date" name="log_date" class="form-control">
                            </div>

                            <div class="col-md-3 mb-2">
                                <label class="form-label">ÌåÄÏõê</label>
                                <select name="member_id" class="form-select" required>
                                    <option value="">ÏÑ†ÌÉù</option>
                                    {% for m in members %}
                                    <option value="{{ m.id }}">{{ m.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 mb-2">
                                <label class="form-label">ÌõÑÏõêÍ∏àÏï°</label>
                                <input type="number" name="sponsor_amount" class="form-control" value="0">
                            </div>

                            <div class="col-md-3 mb-2">
                                <label class="form-label">Í±¥Ïàò</label>
                                <input type="number" name="count" class="form-control" value="1">
                            </div>
                        </div>

                        <button class="btn btn-success mt-2">Ï†ÄÏû•</button>

                    </form>
                </div>
            </div>
        </div>

    </div>


    <!-- ÎÇòÏùò ÏÑ±Í≥º Í∏∞Î°ù -->
    <div class="row mb-4">

        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">ÎÇòÏùò ÏÑ±Í≥º Í∏∞Î°ù</div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr><th>ÎÇ†Ïßú</th><th class="text-end">Í∏àÏï°</th><th class="text-end">Í±¥Ïàò</th></tr>
                        </thead>
                        <tbody>
                        {% for log in my_logs %}
                            <tr>
                                <td>{{ log.log_date }}</td>
                                <td class="text-end">{{ "{:,}".format(log.sponsor_amount) }}</td>
                                <td class="text-end">{{ log.count }}</td>
                            </tr>
                        {% endfor %}
                        {% if my_logs|length == 0 %}
                            <tr><td colspan="3" class="text-center text-muted py-3">Í∏∞Î°ù ÏóÜÏùå</td></tr>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Í∑∏ÎûòÌîÑ -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">Í∑∏ÎûòÌîÑ</div>
                <div class="card-body">
                    <canvas id="amountChart" height="160"></canvas>
                    <canvas id="countChart" height="160"></canvas>
                </div>
            </div>
        </div>

    </div>


    <!-- Ï†ÑÏ≤¥ ÏµúÍ∑º Í∏∞Î°ù -->
    <div class="card">
        <div class="card-header">ÏµúÍ∑º ÏÑ±Í≥º Í∏∞Î°ù</div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ÎÇ†Ïßú</th>
                        <th>ÌåÄÏõê</th>
                        <th class="text-end">Í∏àÏï°</th>
                        <th class="text-end">Í±¥Ïàò</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>

                {% for log in logs %}
                <tr>
                    <td>{{ log.log_date }}</td>
                    <td>
                        <a href="/member/{{ log.member.id }}">{{ log.member.name }}</a>
                    </td>
                    <td class="text-end">{{ "{:,}".format(log.sponsor_amount) }}</td>
                    <td class="text-end">{{ log.count }}</td>
                    <td class="text-end">
                        <form method="post" action="/delete/{{ log.id }}">
                            <button class="btn btn-sm btn-outline-danger">ÏÇ≠Ï†ú</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}

                {% if logs|length == 0 %}
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">Í∏∞Î°ù ÏóÜÏùå</td>
                </tr>
                {% endif %}

                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Í∑∏ÎûòÌîÑ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
<script>
    const labels = {{ chart_labels | tojson }};
    const amounts = {{ chart_amounts | tojson }};
    const counts  = {{ chart_counts | tojson }};

    // Í∏àÏï° Í∑∏ÎûòÌîÑ
    if (labels.length > 0) {
      new Chart(document.getElementById("amountChart"), {
        type: "bar",
        data: { labels: labels, datasets: [{ data: amounts, label: "ÌõÑÏõêÍ∏àÏï°" }] },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    // Í±¥Ïàò Í∑∏ÎûòÌîÑ
    if (labels.length > 0) {
      new Chart(document.getElementById("countChart"), {
        type: "bar",
        data: { labels: labels, datasets: [{ data: counts, label: "Í±¥Ïàò" }] },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }
</script>

</body>
</html>

