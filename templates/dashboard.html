<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WMÏÑ±Í≥º</title>
<link rel="manifest" href="/static/manifest.json">
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/static/service-worker.js");
  }
</script>
<meta name="theme-color" content="#000000">

    <!-- Î∂ÄÌä∏Ïä§Ìä∏Îû© -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <!-- Chart.js (Í∑∏ÎûòÌîÑÏö©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="mb-1">WMÏÑ±Í≥º</h1>
<p class="text-muted mb-4">Ïò§Îäò ÎÇ†Ïßú: {{ today.strftime('%Y-%m-%d') }}</p>
<!-- ÌåÄÏõê Î™©Î°ù ÌëúÏãú -->
<div class="card mb-4">
    <div class="card-header">ÌåÄÏõê Î™©Î°ù</div>
    <div class="card-body">
        {% if members %}
            <ul class="mb-0">
                {% for m in members %}
                <li>
                    <a href="/member/{{ m.id }}">{{ m.name }}</a>
                    {% if m.role %} <span class="text-muted">({{ m.role }})</span> {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted mb-0">Îì±Î°ùÎêú ÌåÄÏõêÏù¥ ÏóÜÏäµÎãàÎã§.</p>
        {% endif %}
    </div>
</div>

<!-- Ï°∞Ìöå Ïõî + Í∏∞Í∞Ñ Í≤ÄÏÉâ -->
<form method="get" class="mb-4">
    <div class="row g-2 align-items-center mb-2">
        <div class="col-auto">
            <label class="col-form-label">Ï°∞Ìöå Ïõî</label>
        </div>
        <div class="col-auto">
            <input type="month" name="month" class="form-control" value="{{ current_month }}">
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-primary" type="submit">Ïõî Ï†ÅÏö©</button>
        </div>
        <div class="col-auto">
            <span class="text-muted small">(ÌòÑÏû¨: {{ current_month }})</span>
        </div>
    </div>

    <div class="row g-2 align-items-center">
        <div class="col-auto">
            <label class="col-form-label">Í∏∞Í∞Ñ Í≤ÄÏÉâ</label>
        </div>
        <div class="col-auto">
            <input type="date" name="start_date" class="form-control" value="{{ start_date_value }}">
        </div>
        <div class="col-auto">
            <span class="col-form-label">~</span>
        </div>
        <div class="col-auto">
            <input type="date" name="end_date" class="form-control" value="{{ end_date_value }}">
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-success" type="submit">Í∏∞Í∞Ñ Ï†ÅÏö©</button>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-secondary" type="submit"
                    onclick="this.form.start_date.value=''; this.form.end_date.value='';">
                Í∏∞Í∞Ñ Ï¥àÍ∏∞Ìôî
            </button>
        </div>
    </div>
</form>


    <!-- ÏúÑ: ÌåÄÏõê Ï∂îÍ∞Ä / ÏÑ±Í≥º Í∏∞Î°ù ÏûÖÎ†• -->
    <div class="row mb-4">
        <!-- ÌåÄÏõê Ï∂îÍ∞Ä -->
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">ÌåÄÏõê Í¥ÄÎ¶¨</div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('add_member') }}">
                        <div class="mb-2">
                            <label class="form-label">Ïù¥Î¶Ñ</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">ÏßÅÏ±Ö / Ïó≠Ìï†</label>
                            <input type="text" name="role" class="form-control" placeholder="Ïòà: ÎÇò, ÌåÄÏõêA Îì±">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Î©îÎ™®</label>
                            <textarea name="note" class="form-control" rows="2"></textarea>
                        </div>
                        <button class="btn btn-primary w-100" type="submit">ÌåÄÏõê Ï∂îÍ∞Ä</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ÏÑ±Í≥º Í∏∞Î°ù ÏûÖÎ†• -->
        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header">ÏÑ±Í≥º Í∏∞Î°ù</div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('add_log') }}">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">ÎÇ†Ïßú</label>
                                <input type="date" name="log_date" class="form-control">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">ÎàÑÍµ¨</label>
                                <select name="member_id" class="form-select" required>
                                    <option value="">ÏÑ†ÌÉù</option>
                                    {% for m in members %}
                                    <option value="{{ m.id }}">{{ m.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">ÌõÑÏõêÍ∏àÏï°(Ïõê)</label>
                                <input type="number" name="sponsor_amount" class="form-control" value="0">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Í±¥Ïàò</label>
                                <input type="number" name="count" class="form-control" value="1">
                            </div>
                        </div>
                        <button class="btn btn-success mt-2" type="submit">Í∏∞Î°ù Ï†ÄÏû•</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ÎÇòÏùò ÏÑ±Í≥ºÍ∏∞Î°ù -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    ÎÇòÏùò ÏÑ±Í≥ºÍ∏∞Î°ù
                    {% if my_member %}
                        <small class="text-muted">({{ my_member.name }} Í∏∞Ï§Ä)</small>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>ÎÇ†Ïßú</th>
                                <th class="text-end">Í∏àÏï°(Ïõê)</th>
                                <th class="text-end">Í±¥Ïàò</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for log in my_logs %}
                            <tr>
                                <td>{{ log.log_date.strftime('%Y-%m-%d') }}</td>
                                <td class="text-end">{{ "{:,}".format(log.sponsor_amount) }}</td>
                                <td class="text-end">{{ log.count }}</td>
                            </tr>
                            {% endfor %}
                            {% if my_logs|length == 0 %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-3">
                                    ÏïÑÏßÅ ÎÇòÏùò ÏÑ±Í≥º Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.
                                </td>
                            </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÏÑ±Í≥ºÌëú (Í∑∏ÎûòÌîÑ) -->
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">ÏÑ±Í≥ºÌëú (Í∑∏ÎûòÌîÑ)</div>
                <div class="card-body">
                    <p class="small text-muted">ÌåÄÏõêÎ≥Ñ Í∏àÏï° / Í±¥Ïàò ÎπÑÍµê</p>
                    <canvas id="amountChart" class="mb-3" height="160"></canvas>
                    <canvas id="countChart" height="160"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Ï†ÑÏ≤¥ ÏµúÍ∑º ÏÑ±Í≥º Í∏∞Î°ù -->
    <div class="card">
        <div class="card-header">ÏµúÍ∑º ÏÑ±Í≥º Í∏∞Î°ù (ÏµúÎåÄ 50Í∞ú)</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>ÎÇ†Ïßú</th>
                        <th>ÎàÑÍµ¨</th>
                        <th class="text-end">ÌõÑÏõêÍ∏àÏï°(Ïõê)</th>
                        <th class="text-end">Í±¥Ïàò</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.log_date.strftime('%Y-%m-%d') }}</td>
                        <td>
    <a href="/member/{{ log.member.id }}">
        {{ log.member.name }}
    </a>
</td>

                        <td class="text-end">{{ "{:,}".format(log.sponsor_amount) }}</td>
                        <td class="text-end">{{ log.count }}</td>
                        <td class="text-end">
                            <form method="post" action="{{ url_for('delete_log', log_id=log.id) }}">
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('ÏÇ≠Ï†úÌï†Íπå?');">
                                    ÏÇ≠Ï†ú
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if logs|length == 0 %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</td>
                    </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    const labels = {{ chart_labels | tojson }};
    const amounts = {{ chart_amounts | tojson }};
    const counts = {{ chart_counts | tojson }};

    const ctxAmount = document.getElementById('amountChart');
    if (ctxAmount && labels.length > 0) {
        new Chart(ctxAmount, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ÌõÑÏõêÍ∏àÏï°(Ïõê)',
                    data: amounts
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    const ctxCount = document.getElementById('countChart');
    if (ctxCount && labels.length > 0) {
        new Chart(ctxCount, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Í±¥Ïàò',
                    data: counts
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        precision: 0
                    }
                }
            }
        });
    }
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } 
    from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBy_EMdPVGh2u4UEXlro90TZcCl_mfTg_s",
    authDomain: "wm-performance.firebaseapp.com",
    projectId: "wm-performance",
    storageBucket: "wm-performance.firebasestorage.app",
    messagingSenderId: "802188460964",
    appId: "1:802188460964:web:2f464c2ea4eed83ab93731",
  };

  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  // üî• ÎÑàÍ∞Ä FirebaseÏóêÏÑú Î∞õÏùÄ VAPID PUBLIC KEY
  const vapidKey = "Z6n18eqh0x5GqnZl7pxLvuNAcDvlnCkOqNtu4tB6138";

  // üîî Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠ + FCM ÌÜ†ÌÅ∞ Î∞úÍ∏â
  async function requestPermission() {
    const permission = await Notification.requestPermission();
    if (permission === "granted") {
      const token = await getToken(messaging, {
        vapidKey: vapidKey
      });

      console.log("üî• FCM Token:", token);
      alert("ÏïåÎ¶ºÏù¥ ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§!");

      // TODO: ÌïÑÏöîÌïòÎ©¥ Ïù¥ ÌÜ†ÌÅ∞ÏùÑ DBÏóê Ï†ÄÏû•ÌïòÏó¨ ÌäπÏ†ï Í∏∞Í∏∞Î°ú ÏïåÎ¶º Î≥¥ÎÇ¥Í∏∞ Í∞ÄÎä•
    } else {
      alert("ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.");
    }
  }

  // ÌéòÏù¥ÏßÄÍ∞Ä Î°úÎìúÎêòÎ©¥ ÏûêÎèô Ïã§Ìñâ or Î≤ÑÌäº ÎßåÎì§Ïñ¥ Ïã§Ìñâ Í∞ÄÎä•
  requestPermission();

  // üîî ÌéòÏù¥ÏßÄÍ∞Ä Ïó¥Î†§ÏûàÏùÑ Îïå Ïò§Îäî ÏïåÎ¶º Ï≤òÎ¶¨
  onMessage(messaging, (payload) => {
    console.log("üì© Foreground Message:", payload);

    new Notification(payload.notification.title, {
      body: payload.notification.body,
      icon: "/static/icon192.png"
    });
  });
</script>

</body>
</html>
